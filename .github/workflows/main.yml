name: Convert Model to MLModel

on:
  workflow_dispatch:  # Allows manual triggering
  push:               # Runs when changes are pushed to main
    branches:
      - main
    paths:
      - 'model.tar.gz'  # Only runs when model.tar.gz changes

jobs:
  convert-to-mlmodel:
    runs-on: macos-latest  # macOS runner needed for coremltools
    
    steps:
    # Checkout the repository
    - name: Checkout Repository
      uses: actions/checkout@v3

    # Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'  # Specify a compatible Python version

    # Install dependencies
    - name: Install Dependencies
      run: |
        pip install tensorflow==2.9.0 coremltools  # Specify a compatible TensorFlow version

    # Extract and convert the model
    - name: Convert to MLModel
      run: |
        # Extract the tar.gz file
        mkdir -p ./extracted_model
        tar -xzf ./model.tar.gz -C ./extracted_model/

        # Python script to convert
        python - <<'EOF'
        import tensorflow as tf
        import coremltools as ct
        import os

        # Find the model directory in extracted files
        model_dir = './extracted_model/'
        for item in os.listdir(model_dir):
            if os.path.isdir(os.path.join(model_dir, item)):
                model_path = os.path.join(model_dir, item)
                break

        # Load TensorFlow model
        tf_model = tf.keras.models.load_model(model_path)

        # Convert to Core ML
        mlmodel = ct.convert(
            tf_model,
            source='tensorflow',
            convert_to='mlmodel'
        )

        # Save the converted model
        output_path = './converted_model.mlmodel'
        mlmodel.save(output_path)
        EOF

    # Commit and push the converted model
    - name: Commit and Push to GitHub
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add ./converted_model.mlmodel
        git commit -m "Add converted MLModel [$(date +'%Y-%m-%d')]" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}